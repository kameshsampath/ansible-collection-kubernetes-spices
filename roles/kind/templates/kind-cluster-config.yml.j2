#jinja2: lstrip_blocks: "True"
---
kind: Cluster
apiVersion: kind.x-k8s.io/v1alpha4
{%if kind_ip_family == "ipv6" or kind_ip_family == "dual" %}
networking:
  disableDefaultCNI: {{ disable_cni }}
  ipFamily: {{ kind_ip_family }}
  {% if ansible_os_family == "Darwin" or ansible_os_family == "Windows" %}
  apiServerAddress: "127.0.0.1"
  {% endif %}
  {% if pod_subnet_cidr is defined and pod_subnet_cidr is not none %}
  podSubnet: {{ pod_subnet_cidr }}
  {% endif %}
{% endif %}
nodes:
- role: control-plane
  ## make ingress controller deployed on control plane only  
  kubeadmConfigPatches:
    - |
      kind: InitConfiguration
      nodeRegistration:
        kubeletExtraArgs:
          node-labels: "ingress-ready=true"
  extraPortMappings:
  {% for m in extra_port_mappings %}
    {% set hostPort = ( m.split(':')[1] | int ) | kameshsampath.kubernetes_spices.offset_port %}
    {% set containerPort =  m.split(':')[2] | int  %}
    {% if m.split(':')[1] ==  m.split(':')[2] %}
        {% set containerPort = hostPort  %}
    {% endif %}
    - containerPort: {{ containerPort }}
      hostPort: {{ hostPort }}
      {% if kind_ip_family == "ipv6" and m.split(':')[0] == "0.0.0.0" %}
      listenAddress: "::"
      {% else %}
      listenAddress: {{ m.split(':')[0] }}
      {% endif %}
  {% endfor %}
- role: worker
  kubeadmConfigPatches:
    - |
      kind: InitConfiguration
      nodeRegistration:
        kubeletExtraArgs:
          node-labels: 'node-role.kubernetes.io/worker: ""'
{% if kind_custom_registry %}
containerdConfigPatches:
  - |-
      [plugins."io.containerd.grpc.v1.cri".registry.mirrors."localhost:{{container_registry_port}}"]
      endpoint = ["http://{{container_registry_name}}:{{container_registry_port}}"]
      [plugins."io.containerd.grpc.v1.cri".registry.mirrors."{{container_registry_name}}:{{container_registry_port}}"]
      endpoint = ["http://{{container_registry_name}}:{{container_registry_port}}"]
      {% if kind_custom_registry_aliases %}
      {% for a in kind_custom_registry_aliases %}
      [plugins."io.containerd.grpc.v1.cri".registry.mirrors."{{ a }}"]
      endpoint = ["http://{{container_registry_name}}:{{container_registry_port}}"]
      {% endfor %}
      {% endif  %}
{% else %}
containerdConfigPatches: {}
{% endif %}
